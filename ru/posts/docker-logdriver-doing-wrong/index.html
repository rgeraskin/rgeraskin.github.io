<!DOCTYPE html>
<html lang="ru" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Docker Logdriver: doing it wrong &middot; DevOps Blog</title>
  <meta name="description" content="Docker userland-proxy мешает работе logdriver&#39;a, ломая логику async-connect. Как следствие, будут потеряны все логи, отправленные logdriver&#39;ом до момента готовности аггрегатора логов, например, *Fluentd*." />
  <link rel="apple-touch-icon" sizes="180x180" href="https://rgeraskin.com/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://rgeraskin.com/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://rgeraskin.com/favicon-16x16.png">
  <link rel="manifest" href="https://rgeraskin.com/site.webmanifest">
  <script>


function myFunction() {
  document.getElementById("myDropdown").classList.toggle("show");
}


window.onclick = function(event) {
  if (!event.target.matches('.dropbtn')) {
    var dropdowns = document.getElementsByClassName("dropdown-content");
    var i;
    for (i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
}
</script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  
  
  
  
  <link href="https://rgeraskin.com/css/concated.min.css" rel="stylesheet">
  
  
</head>

  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="https://rgeraskin.com//ru" class="nav-text">rngeraskin@blog ~/posts $
      </a></h1>
  <div class="nav-break"></div>
  <div class="dropdown">
    <button onclick="myFunction()" class="dropbtn">LANG=ru<span> &#9660;</span></button>
    <div id="myDropdown" class="dropdown-content">
      
      <a href="https://rgeraskin.com/en/posts/docker-logdriver-doing-wrong/" title="English">export LANG=en</a>
      
    </div>
  </div>
  <div class="nav-links">
    <button class="nav-links-btn" onclick="location.href='/ru/about'" type="button">cd ~/about</button>
    </div>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu"
      aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="https://rgeraskin.com/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://rgeraskin.com/ru/about/" class="hamburger-menu-overlay-link">About me</a></li>
      
      <li><a href="https://rgeraskin.com/ru/categories/devops/" class="hamburger-menu-overlay-link">devops</a></li>
      
      <li><a href="https://rgeraskin.com/ru/categories/docker/" class="hamburger-menu-overlay-link">docker</a></li>
      
      <li><a href="https://rgeraskin.com/ru/categories/k8s/" class="hamburger-menu-overlay-link">K8S</a></li>
      
      <li><a href="https://rgeraskin.com/ru/categories/kubernetes/" class="hamburger-menu-overlay-link">kubernetes</a></li>
      
      <li><a href="https://rgeraskin.com/ru/categories/logs/" class="hamburger-menu-overlay-link">logs</a></li>
      
      
    </ul>
  </div>
</nav>
    <main class="content side-text-padding">
      <article class="post dropcase">
        <header class="post-header">
          <h1 class="post-title">Docker Logdriver: doing it wrong</h1>
          <p class="post-date">Posted <time datetime="2020-06-07">Jun 7, 2020</time></p>
        </header>
        
        
        <h2 id="tldr">TL;DR</h2>
<blockquote>
<p>Docker userland-proxy мешает работе logdriver&rsquo;a, ломая логику async-connect. Как следствие, будут потеряны все логи, отправленные logdriver&rsquo;ом до момента готовности аггрегатора логов, например, <em>Fluentd</em>.</p>
</blockquote>
<h2 id="никто-не-любит-logging-driverы">Никто не любит logging driver&rsquo;ы</h2>
<p>Docker Log Driver - итересная штука, созданная, чтобы облегчить сбор логов. Казалось бы, подключил логдрайвер - и забыл. Но не все так просто, и в реальных проектах зачастую не используют logdriver, предпочитая просто парсить логи докера. Почему?</p>
<ol>
<li>
<p>Прежде всего - <em>split logging</em>, который в Docker CE поддерживается только с некоторыми драйверами. В общем, проще считать, что его нет. Вроде бы, и зачем он нужен, при живой системе логгирования-то? Но на практике бывает очень удобно подключиться к ноде и посмотреть последние события через <code>docker logs</code>.</p>
</li>
<li>
<p>Kubernetes лог драйверы не поддерживает. А все либо уже в k8s, либо хотят туда. Nuff said.</p>
</li>
<li>
<p>Работает не очевидно, страшно потерять логи. Читай, <em>&ldquo;попробовал настроить, логи теряются, разбираться не хочется&rdquo;</em>. Парсить json&rsquo;ы надежней.</p>
</li>
</ol>
<p>Если все аргументы выше не заставили передумать, приступим. Настраивать будем log driver для <em>Fluentd</em>.</p>
<h2 id="настройка-типичного-efk">Настройка типичного EFK</h2>
<p>Существует масса руководств по настройке docker log driver, да хотя бы прям в доке docker`a. Как выглядит типичный &ldquo;Getting started guide&rdquo; для EFK?</p>
<p>Простейший <em>fluent.conf</em>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;source&gt;
  @type forward
  @label @out
&lt;/source&gt;

&lt;label @out&gt;
  &lt;match&gt;
    @type elasticsearch
    host elasticsearch
    logstash_format true
    &lt;buffer&gt;
      flush_interval 10
    &lt;/buffer&gt;
  &lt;/match&gt;
&lt;/label&gt;
</code></pre></div><p>Добавляем во <em>Fluentd</em> elasticsearch плагин:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#00f">FROM</span><span style="color:#009c00"> fluent/fluentd:v1.10-1</span>

<span style="color:#00f">USER</span><span style="color:#009c00"> root</span>

<span style="color:#00f">RUN</span> gem install fluent-plugin-elasticsearch <span style="color:#009c00">\
</span><span style="color:#009c00"></span> &amp;&amp; gem sources --clear-all <span style="color:#009c00">\
</span><span style="color:#009c00"></span> &amp;&amp; rm -rf /tmp/* /var/tmp/* /usr/lib/ruby/gems/*/cache/*.gem

<span style="color:#00f">USER</span><span style="color:#009c00"> fluent</span>
</code></pre></div><p><em>docker-compose.yml</em>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">version: <span style="color:#009c00">&#34;3.6&#34;</span>

services:
  fluentd:
    image: fluentd:efk
    build: .
    ports:
      - 127.0.0.1:24224:24224
    volumes:
      - ./fluent.conf:/fluentd/etc/fluent.conf
    networks:
      - internal

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:7.7.0
    environment:
      - discovery.type=single-node
    networks:
      - internal
    logging:
      driver: fluentd
      options:
        fluentd-async-connect: <span style="color:#009c00">&#34;true&#34;</span>
        fluentd-sub-second-precision: <span style="color:#009c00">&#34;true&#34;</span>

  kibana:
    image: docker.elastic.co/kibana/kibana-oss:7.7.0
    ports:
      - 5601:5601
    depends_on:
      - elasticsearch
    networks:
      - internal
      - external
    logging:
      driver: fluentd
      options:
        fluentd-async-connect: <span style="color:#009c00">&#34;true&#34;</span>
        fluentd-sub-second-precision: <span style="color:#009c00">&#34;true&#34;</span>

networks:
  internal:
  external:
</code></pre></div><p>Абсолютно обычный сетап EFK. Остается добавить только приложение, базу и т.п.</p>
<p>Отдельно остановлюсь на опциях:</p>
<ul>
<li><code>fluentd-sub-second-precision</code> - логгировать время с субсекундной точностью. Благодаря этому логи в кибане будут отображаться в правильном порядке (с большей вероятностью).</li>
<li><code>fluentd-async-connect</code> - если не удается подключиться к <em>Fluentd</em>, то не падаем с ошибкой, а продолжаем попытки коннекта, буфферизируя неотправленные логи.</li>
</ul>
<h2 id="что-же-не-так">Что же не так?</h2>
<p>Все просто, с подобным конфигом мы будем терять все логи до момента готовности <em>Fluentd</em>. Причем, момент готовности != моменту старта контейнера.</p>
<p>Это легко проверить, подняв данный <code>docker-compose.yml</code>: логов старта elasticsearch и kibana в самом elasticsearch не будет.</p>
<p>Начинаем разбираться. Кажется, что всему виной опция <code>fluentd-async-connect</code>, ведь именно она отвечает за то, чтобы копить логи, пока не станет доступным <em>Fluentd</em>. Для подтверждения данной теории можно запустить <code>tcpdump</code> и восстановить ход событий:</p>
<p><em>(кибану можно исключить из процесса для ясности)</em></p>
<ul>
<li>стартует <em>fluentd</em></li>
<li>стартует <em>elastic</em></li>
<li><em>fluentd</em> ждет готовности <em>elastic</em>: порт <code>24224</code> еще не открыт</li>
<li><em>elastic</em> насыпает логов, логи вроде как отправляются в <code>localhost:24224</code>, эти логи потеряны</li>
<li><em>fluentd</em> видит <em>elastic</em>, открывает порт, с этого момента логи логгируются, как и ожидалось</li>
</ul>
<p>Почему же log driver отправляет логи, хотя порт <code>24224</code> еще не открыт? А точно ли он не открыт? Это легко проверить более высокоуровневыми средствами.</p>
<p>Пытаемся подключиться к <code>24224</code> до старта compose - ожидаемый отлуп:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ telnet localhost 24224
Trying 127.0.0.1...
telnet: Unable to connect to remote host: Connection refused
$
</code></pre></div><p>Пытаемся подключиться к <code>24224</code> сразу после старта compose, т.е. до открытия порта <em>Fluentd</em>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ telnet localhost 24224
Trying 127.0.0.1...
Connected to localhost.
Escape character is <span style="color:#009c00">&#39;^]&#39;</span>.
Connection closed by foreign host.
$
</code></pre></div><p><strong>WTF?</strong> Кто-то уже слушает порт и сбрасывает соединение!</p>
<p>Пытаемся подключиться к <code>24224</code> после того как <em>Fluentd</em> &ldquo;увидел&rdquo; elasticsearch и, соответственно, выставил порт - ожидаемо, подключились:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ telnet localhost 24224
Trying 127.0.0.1...
Connected to localhost.
Escape character is <span style="color:#009c00">&#39;^]&#39;</span>.
</code></pre></div><h2 id="что-делать-и-кто-виноват">Что делать и кто виноват?</h2>
<p>Путем недолгих размышлений было выяснено, что это <em>docker-proxy</em>. Отключаем:</p>
<p><em>/etc/docker/daemon.json</em>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  &#34;userland-proxy&#34;: <span style="color:#00f">false</span>
}
</code></pre></div><p>И все приходит в норму: до старта worker&rsquo;a <em>Fluentd</em> и открытия порта по <code>24224</code> никто не отвечает, а благодаря <code>fluentd-async-connect</code> log driver пытается отправить логи, повторяя попытки согласно настройкам. И после готовности <em>Fluentd</em> логи будут успешно отправлены, без потерь.</p>
<h3 id="что-за-docker-proxy">Что за docker-proxy?</h3>
<p>Не вдаваясь в подробности, <em>docker userland-proxy</em> - это то, что используется сейчас чаще всего совместно с <strong>IPv6</strong>, соответственно, в большинстве случаев, может быть безболезненно отключено.</p>
<h2 id="вывод-от-ipv6-не-уйти">Вывод: от IPv6 не уйти.</h2>
<p>К сожалению, это не единственная особенность в работе с docker log driver, достаточно взглянуть на багтрекер&hellip; В т.ч. такие нюансы - еще один отличный довод в пользу отказа от logdrivers.</p>

      </article>
      
    </main>
    <nav class="end-nav side-padding">
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)"
  href="https://rgeraskin.com//ru" class="card home-card" style="background-image: url( https://rgeraskin.com/img/grey-cloud.jpg )" rel="bookmark" >
  Home
</a>
    </nav>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
  
  <script src="https://rgeraskin.com/js/core.min.js"></script>

  </body>
</html>
